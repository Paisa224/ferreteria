generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int       @id @default(autoincrement())
  name          String
  username      String    @unique
  ci            String    @unique
  password_hash String
  is_active     Boolean   @default(true)

  user_roles    UserRole[]
  refreshTokens RefreshToken[]

  openedCashSessions CashSession[] @relation("CashSessionOpenedBy")
  closedCashSessions CashSession[] @relation("CashSessionClosedBy")

  cashMovementsCreated CashMovement[] @relation("CashMovementCreatedBy")
  cashCounts           CashCount[]    @relation("CashCountCountedBy")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Role {
  id               Int              @id @default(autoincrement())
  name             String           @unique
  user_roles       UserRole[]
  role_permissions RolePermission[]
}

model Permission {
  id               Int              @id @default(autoincrement())
  key              String           @unique
  role_permissions RolePermission[]
}

model UserRole {
  user_id Int
  role_id Int

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role Role @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@id([user_id, role_id])
  @@index([role_id])
}

model RolePermission {
  role_id       Int
  permission_id Int

  role       Role       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@id([role_id, permission_id])
  @@index([permission_id])
}

model RefreshToken {
  id         Int      @id @default(autoincrement())
  user_id    Int
  token_hash String
  expires_at DateTime
  revoked_at DateTime?

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([user_id])
  @@index([expires_at])
}

enum CashSessionStatus {
  OPEN
  CLOSED
}

model CashRegister {
  id        Int          @id @default(autoincrement())
  name      String       @unique
  is_active Boolean      @default(true)

  sessions  CashSession[]

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model CashSession {
  id               Int               @id @default(autoincrement())

  cash_register_id Int
  opened_by        Int
  opened_at        DateTime          @default(now())
  opening_amount   Decimal           @db.Decimal(12, 2)

  closed_by        Int?
  closed_at        DateTime?
  closing_amount   Decimal?          @db.Decimal(12, 2)

  status           CashSessionStatus @default(OPEN)

  closed_with_cash_count_id Int?     @unique
  closedWithCount           CashCount? @relation("CashSessionClosedWithCount", fields: [closed_with_cash_count_id], references: [id])

  cashRegister     CashRegister     @relation(fields: [cash_register_id], references: [id])

  openedByUser     User             @relation("CashSessionOpenedBy", fields: [opened_by], references: [id])
  closedByUser     User?            @relation("CashSessionClosedBy", fields: [closed_by], references: [id])

  movements   CashMovement[]
  counts      CashCount[]

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([cash_register_id, status])
  @@index([opened_by, opened_at])
}

enum CashMovementType {
  IN
  OUT
}

model CashMovement {
  id             Int              @id @default(autoincrement())
  cash_session_id Int

  type           CashMovementType
  concept        String
  amount         Decimal          @db.Decimal(12, 2)
  reference      String?

  created_by     Int
  created_at     DateTime         @default(now())

  cashSession    CashSession      @relation(fields: [cash_session_id], references: [id])
  createdByUser  User             @relation("CashMovementCreatedBy", fields: [created_by], references: [id])

  @@index([cash_session_id, type])
  @@index([created_by, created_at])
}

model CashCount {
  id              Int      @id @default(autoincrement())
  cash_session_id Int

  counted_by      Int
  counted_at      DateTime @default(now())

  total_counted   Decimal  @db.Decimal(12, 2)
  expected_total  Decimal  @db.Decimal(12, 2)
  difference      Decimal  @db.Decimal(12, 2)

  cashSession     CashSession @relation(fields: [cash_session_id], references: [id])
  countedByUser   User        @relation("CashCountCountedBy", fields: [counted_by], references: [id])

  denominations   CashCountDenomination[]

  closedBySession CashSession? @relation("CashSessionClosedWithCount")

  @@index([cash_session_id, counted_at])
}

model CashCountDenomination {
  id            Int      @id @default(autoincrement())
  cash_count_id Int

  denom_value   Decimal  @db.Decimal(12, 2)
  qty           Int
  subtotal      Decimal  @db.Decimal(12, 2)

  cashCount     CashCount @relation(fields: [cash_count_id], references: [id])

  @@index([cash_count_id])
}
