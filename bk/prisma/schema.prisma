generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int       @id @default(autoincrement())
  name          String
  username      String    @unique
  ci            String    @unique
  password_hash String
  is_active     Boolean   @default(true)

  user_roles    UserRole[]
  refreshTokens RefreshToken[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Role {
  id               Int              @id @default(autoincrement())
  name             String           @unique
  user_roles       UserRole[]
  role_permissions RolePermission[]
}

model Permission {
  id               Int              @id @default(autoincrement())
  key              String           @unique
  role_permissions RolePermission[]
}

model UserRole {
  user_id Int
  role_id Int

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role Role @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@id([user_id, role_id])
  @@index([role_id])
}

model RolePermission {
  role_id       Int
  permission_id Int

  role       Role       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@id([role_id, permission_id])
  @@index([permission_id])
}

model RefreshToken {
  id         Int      @id @default(autoincrement())
  user_id    Int
  token_hash String
  expires_at DateTime
  revoked_at DateTime?

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([user_id])
  @@index([expires_at])
}
